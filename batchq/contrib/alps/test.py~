import pyalps
import matplotlib.pyplot as plt
import pyalps.plot

parms = []
for l in [2,4,8,16,32,48]:
   parms.append(
       {
         'LATTICE'        : "square lattice",
         'T'              : 2.269186,
         'J'              : 1 ,
         'THERMALIZATION' : 10000,
         'SWEEPS'         : 50000,
         'UPDATE'         : "local",
         'MODEL'          : "Ising",
         'L'              : l
       }
   )

input_file = pyalps.writeInputFiles('parm1a',parms)

from batchq.queues import NoHUPSSH
from batchq.contrib.alps import runApplicationBackground
q = loadq(NoHUPSSH, "/Users/tfr/RemoteJobs/TestInDir/satis")

if runApplicationBackground('spinmc',input_file,Tmin=5,writexml=True):
    q.clean()

    binning = pyalps.loadBinningAnalysis(pyalps.getResultFiles(prefix='parm1a'),'|Magnetization|')
    binning = pyalps.flatten(binning)

    for dataset in binning:
        dataset.props['label'] = 'L='+str(dataset.props['L'])

    plt.figure()
    plt.xlabel('binning level')
    plt.ylabel('Error of |Magnetization|')
    pyalps.plot.plot(binning)
    plt.legend()
    plt.show()

    for dataset in binning:
        plt.figure()
        plt.title('Binning analysis for L='+str(dataset.props['L']))
        plt.xlabel('binning level')
        plt.ylabel('Error of |Magnetization|')
        pyalps.plot.plot(dataset)
